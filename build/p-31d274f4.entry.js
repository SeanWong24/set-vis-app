import{r as t,h as e,H as n}from"./p-ddbb1df8.js";import"./p-bec3b19e.js";import"./p-58d13c5e.js";import"./p-f3a0c163.js";import{l as i}from"./p-d5d1c985.js";import{s as a}from"./p-38942298.js";function o(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function r(t){let e=t,n=t;function i(t,e,i,a){for(null==i&&(i=0),null==a&&(a=t.length);i<a;){const o=i+a>>>1;n(t[o],e)<0?i=o+1:a=o}return i}return 1===t.length&&(e=(e,n)=>t(e)-n,n=function(t){return(e,n)=>o(t(e),n)}(t)),{left:i,center:function(t,n,a,o){null==a&&(a=0),null==o&&(o=t.length);const r=i(t,n,a,o-1);return r>a&&e(t[r-1],n)>-e(t[r],n)?r-1:r},right:function(t,e,i,a){for(null==i&&(i=0),null==a&&(a=t.length);i<a;){const o=i+a>>>1;n(t[o],e)>0?a=o:i=o+1}return i}}}const s=r(o).right;function l(t,e){let n;if(void 0===e)for(const e of t)null!=e&&(n<e||void 0===n&&e>=e)&&(n=e);else{let i=-1;for(let a of t)null!=(a=e(a,++i,t))&&(n<a||void 0===n&&a>=a)&&(n=a)}return n}function u(t,e){let n;if(void 0===e)for(const e of t)null!=e&&(n>e||void 0===n&&e>=e)&&(n=e);else{let i=-1;for(let a of t)null!=(a=e(a,++i,t))&&(n>a||void 0===n&&a>=a)&&(n=a)}return n}function c(t,e,n){const i=t[e];t[e]=t[n],t[n]=i}function h(t,e,n){if(i=(t=Float64Array.from(function*(t,e){if(void 0===e)for(let e of t)null!=e&&(e=+e)>=e&&(yield e);else{let n=-1;for(let i of t)null!=(i=e(i,++n,t))&&(i=+i)>=i&&(yield i)}}(t,n))).length){if((e=+e)<=0||i<2)return u(t);if(e>=1)return l(t);var i,a=(i-1)*e,r=Math.floor(a),s=l(function t(e,n,i=0,a=e.length-1,r=o){for(;a>i;){if(a-i>600){const o=a-i+1,s=n-i+1,l=Math.log(o),u=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*u*(o-u)/o)*(s-o/2<0?-1:1);t(e,n,Math.max(i,Math.floor(n-s*u/o+c)),Math.min(a,Math.floor(n+(o-s)*u/o+c)),r)}const o=e[n];let s=i,l=a;for(c(e,i,n),r(e[a],o)>0&&c(e,i,a);s<l;){for(c(e,s,l),++s,--l;r(e[s],o)<0;)++s;for(;r(e[l],o)>0;)--l}0===r(e[i],o)?c(e,i,l):(++l,c(e,l,a)),l<=n&&(i=l+1),n<=l&&(a=l-1)}return e}(t,r).subarray(0,r+1));return s+(u(t.subarray(r+1))-s)*(a-r)}}r((function(t){return null===t?NaN:+t}));var f={value:()=>{}};function d(){for(var t,e=0,n=arguments.length,i={};e<n;++e){if(!(t=arguments[e]+"")||t in i||/[\s.]/.test(t))throw new Error("illegal type: "+t);i[t]=[]}return new p(i)}function p(t){this._=t}function v(t,e){return t.trim().split(/^|\s+/).map((function(t){var n="",i=t.indexOf(".");if(i>=0&&(n=t.slice(i+1),t=t.slice(0,i)),t&&!e.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:n}}))}function m(t,e){for(var n,i=0,a=t.length;i<a;++i)if((n=t[i]).name===e)return n.value}function w(t,e,n){for(var i=0,a=t.length;i<a;++i)if(t[i].name===e){t[i]=f,t=t.slice(0,i).concat(t.slice(i+1));break}return null!=n&&t.push({name:e,value:n}),t}function y(t,e){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(e).domain(t)}return this}p.prototype=d.prototype={constructor:p,on:function(t,e){var n,i=this._,a=v(t+"",i),o=-1,r=a.length;if(!(arguments.length<2)){if(null!=e&&"function"!=typeof e)throw new Error("invalid callback: "+e);for(;++o<r;)if(n=(t=a[o]).type)i[n]=w(i[n],t.name,e);else if(null==e)for(n in i)i[n]=w(i[n],t.name,null);return this}for(;++o<r;)if((n=(t=a[o]).type)&&(n=m(i[n],t.name)))return n},copy:function(){var t={},e=this._;for(var n in e)t[n]=e[n].slice();return new p(t)},call:function(t,e){if((n=arguments.length-2)>0)for(var n,i,a=new Array(n),o=0;o<n;++o)a[o]=arguments[o+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(o=0,n=(i=this._[t]).length;o<n;++o)i[o].value.apply(e,a)},apply:function(t,e,n){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var i=this._[t],a=0,o=i.length;a<o;++a)i[a].value.apply(e,n)}},d("start","end","cancel","interrupt");const g=class{constructor(e){t(this,e),this.variableOptions=["Elevation","MaxTemperature","MinTemperature","Precipitation","Wind","RelativeHumidity","Solar"],this.colorScheme=["#4575b4","#abd9e9","#fee090","#f46d43"],this.timeBy="Month",this.textureDefinitions=['this.textures.lines().orientation("4/8").size(1000)','this.textures.lines().orientation("2/8").size(10)','this.textures.lines().orientation("8/8").size(10)','this.textures.lines().orientation("6/8").size(10)'],this.categorizationMethod="value"}async connectedCallback(){this.SQL=await a({locateFile:t=>"./assets/sql.js/"+t})}render(){var t;return e(n,null,e("ion-header",null,e("ion-toolbar",{color:"primary"},e("ion-title",null,"Weather Vis"," - "+((null===(t=this.file)||void 0===t?void 0:t.name)||"No File Opened")),e("ion-buttons",{slot:"start"},e("ion-back-button",{defaultHref:"/"})),e("ion-buttons",{slot:"end"},e("ion-button",{title:"Open",onClick:()=>this.fileInputElement.click()},e("ion-icon",{slot:"icon-only",name:"open"}))))),e("ion-content",{class:"ion-padding"},e("ion-item",{disabled:!this.file},e("ion-label",null,"Categorization Methody"),e("ion-select",{value:this.categorizationMethod,onIonChange:async({detail:t})=>{this.categorizationMethod=t.value,this.updateData(1),this.updateData(2)}},e("ion-select-option",null,"quantile"),e("ion-select-option",null,"value"))),e("ion-item",{disabled:!this.file},e("ion-label",null,"Variables"),e("ion-select",{multiple:!0,onIonChange:async({detail:t})=>{this.selectedVariables=t.value,this.updateData(1),this.updateData(2)}},this.variableOptions.map(t=>e("ion-select-option",null,t)))),e("ion-item",{disabled:!this.file},e("ion-label",null,"Time By"),e("ion-select",{value:this.timeBy,onIonChange:async({detail:t})=>{this.timeBy=t.value,this.updateData(1),this.updateData(2)}},e("ion-select-option",null,"Day"),e("ion-select-option",null,"Week"),e("ion-select-option",null,"Month"),e("ion-select-option",null,"Quarter "))),e("div",null,e("s-set-vis",{ref:t=>this.setVisElement=t,"parallel-sets-ribbon-tension":.5,parallelSetsDimensions:[""],parallelSetsMaxSegmentLimit:12,parallelSetsTexutureDefinitions:this.textureDefinitions,parallelSetsColorScheme:this.colorScheme,"dark-mode":JSON.parse(localStorage.getItem("isDarkModeEnabled"))}),e("iframe",{width:"600",height:"600",style:{border:"0"},ref:async t=>{this.mapIframeElement=t;const e=await(await fetch("./assets/map.html")).text();t.contentDocument.querySelector("div#map")||(t.contentDocument.open(),t.contentDocument.write(e),t.contentDocument.close(),window.addEventListener("message",e=>{if(e.source===this.mapIframeElement.contentWindow){const n=e.data;switch(n.type){case"hello":t.contentWindow.postMessage({type:"view center point",info:[0,0]},"*");break;case"select rect":this.updateData(1,n.info)}}}))}}),e("ion-button",{onClick:()=>this.mapIframeElement.contentWindow.postMessage({type:"reset range selection"},"*")},"Remove Range Selection")),e("div",null,e("s-set-vis",{ref:t=>this.setVisElement2=t,"parallel-sets-ribbon-tension":.5,parallelSetsDimensions:[""],parallelSetsMaxSegmentLimit:12,parallelSetsTexutureDefinitions:this.textureDefinitions,parallelSetsColorScheme:this.colorScheme,"dark-mode":JSON.parse(localStorage.getItem("isDarkModeEnabled"))}),e("iframe",{width:"600",height:"600",style:{border:"0"},ref:async t=>{this.mapIframeElement2=t;const e=await(await fetch("./assets/map.html")).text();t.contentDocument.querySelector("div#map")||(t.contentDocument.open(),t.contentDocument.write(e),t.contentDocument.close(),window.addEventListener("message",e=>{if(e.source===this.mapIframeElement2.contentWindow){const n=e.data;switch(n.type){case"hello":t.contentWindow.postMessage({type:"view center point",info:[0,0]},"*");break;case"select rect":this.updateData(2,n.info)}}}))}}),e("ion-button",{onClick:()=>this.mapIframeElement2.contentWindow.postMessage({type:"reset range selection"},"*")},"Remove Range Selection"))),e("input",{id:"file-input",type:"file",ref:t=>this.fileInputElement=t,onInput:async({target:t})=>{var e;this.file=null===(e=t.files)||void 0===e?void 0:e[0];const n=await i.create({message:`Opening ${this.file.name}...`});await n.present();const a=await this.file.arrayBuffer();this.DB=new this.SQL.Database(new Uint8Array(a)),await n.dismiss()}}))}async updateData(t,e){const n=await this.queryData(this.selectedVariables,this.timeBy,e);if(1===t){const t=n.filter(t=>"Jan"===t.Date).map(t=>({latitude:t.Latitude,longitude:t.Longitude,value:t["_"+this.selectedVariables[0]],secondaryValue:t["_"+this.selectedVariables[1]]})),e=[...new Set(t.map(t=>t.value))].sort((t,e)=>+t.split(" ")[0]-+e.split(" ")[0]).reduce((t,e,n)=>(t[e]=this.colorScheme[n],t),{}),i=[...new Set(t.map(t=>t.secondaryValue))].sort((t,e)=>+t.split(" ")[0]-+e.split(" ")[0]).reduce((t,e,n)=>(t[e]=this.textureDefinitions[n],t),{});t.forEach(t=>{t.value=e[t.value],t.secondaryValue=i[t.secondaryValue]}),this.mapIframeElement.contentWindow.postMessage({type:"highlight",info:{data:t,marginLatitude:.312,marginLongitude:.312}},"*"),this.mapIframeElement.contentWindow.postMessage({type:"view center point",info:{location:[(this.datasetInfo.maxLatitude+this.datasetInfo.minLatitude)/2,(this.datasetInfo.maxLongitude+this.datasetInfo.minLongitude)/2],zoom:6}},"*"),this.setVisElement.data=n,this.setVisElement.parallelSetsDimensions=this.selectedVariables.map(t=>"_"+t).concat(["Date"]),this.setVisElement.statisticsPlotGroupDefinitions=this.selectedVariables.map(t=>({dimensionName:t,visType:"box"}))}else if(2===t){const t=n.filter(t=>"Jan"===t.Date).map(t=>({latitude:t.Latitude,longitude:t.Longitude,value:t["_"+this.selectedVariables[0]],secondaryValue:t["_"+this.selectedVariables[1]]})),e=[...new Set(t.map(t=>t.value))].sort((t,e)=>+t.split(" ")[0]-+e.split(" ")[0]).reduce((t,e,n)=>(t[e]=this.colorScheme[n],t),{}),i=[...new Set(t.map(t=>t.secondaryValue))].sort((t,e)=>+t.split(" ")[0]-+e.split(" ")[0]).reduce((t,e,n)=>(t[e]=this.textureDefinitions[n],t),{});t.forEach(t=>{t.value=e[t.value],t.secondaryValue=i[t.secondaryValue]}),this.mapIframeElement2.contentWindow.postMessage({type:"highlight",info:{data:t,marginLatitude:.312,marginLongitude:.312}},"*"),this.mapIframeElement2.contentWindow.postMessage({type:"view center point",info:{location:[(this.datasetInfo.maxLatitude+this.datasetInfo.minLatitude)/2,(this.datasetInfo.maxLongitude+this.datasetInfo.minLongitude)/2],zoom:6}},"*"),this.setVisElement2.data=n,this.setVisElement2.parallelSetsDimensions=this.selectedVariables.map(t=>"_"+t).concat(["Date"]),this.setVisElement2.statisticsPlotGroupDefinitions=this.selectedVariables.map(t=>({dimensionName:t,visType:"box"}))}}async queryData(t,e,n){var a,r;let c=[];if((null==t?void 0:t.length)>0&&e){const f=await i.create({message:"Qeurying data..."});let d,p;switch(await f.present(),e){case"Day":d="select Date, Latitude, Longitude, "+t.join(", ")+" from weather",n&&(d+=` where Latitude >= ${n.minLat} and Latitude <= ${n.maxLat} and Longitude >= ${n.minLon} and Longitude <= ${n.maxLon}`);break;case"Week":case"Month":case"Quarter":d="select substr(Date, 0, 8) as Date, Latitude, Longitude, "+t.map(t=>`avg(${t}) as ${t}`).join(", ")+" from weather",n&&(d+=` where Latitude >= ${n.minLat} and Latitude <= ${n.maxLat} and Longitude >= ${n.minLon} and Longitude <= ${n.maxLon}`),d+=" group by substr(Date, 0, 8), Latitude, Longitude"}if(p=null===(a=this.DB.exec(d))||void 0===a?void 0:a[0],c=null==p?void 0:p.values.map(t=>{const e={};for(let n=0;n<t.length;n++)e[p.columns[n]]="Date"===p.columns[n]?this.obtainDateString(t[n]):+t[n];return e}),c)if("quantile"===this.categorizationMethod){const e={};t.forEach(t=>e[t]=function t(){var e,n=[],i=[],a=[];function r(){var t=0,e=Math.max(1,i.length);for(a=new Array(e-1);++t<e;)a[t-1]=h(n,t/e);return l}function l(t){return isNaN(t=+t)?e:i[s(a,t)]}return l.invertExtent=function(t){var e=i.indexOf(t);return e<0?[NaN,NaN]:[e>0?a[e-1]:n[0],e<a.length?a[e]:n[n.length-1]]},l.domain=function(t){if(!arguments.length)return n.slice();n=[];for(let e of t)null==e||isNaN(e=+e)||n.push(e);return n.sort(o),r()},l.range=function(t){return arguments.length?(i=Array.from(t),r()):i.slice()},l.unknown=function(t){return arguments.length?(e=t,l):e},l.quantiles=function(){return a.slice()},l.copy=function(){return t().domain(n).range(i).unknown(e)},y.apply(l,arguments)}().domain(c.map(e=>e[t])).range([.25,.5,.75,1]));const n=(t,e,n)=>{switch(e){case.25:return`${(+u(n)).toFixed(2)} ~ ${(+t[0]).toFixed(2)}`;case.5:return`${(+t[0]).toFixed(2)} ~ ${(+t[1]).toFixed(2)}`;case.75:return`${(+t[1]).toFixed(2)} ~ ${(+t[2]).toFixed(2)}`;case 1:return`${(+t[2]).toFixed(2)} ~ ${(+l(n)).toFixed(2)}`}};c.forEach(i=>t.forEach(t=>i["_"+t]=n(e[t].quantiles(),e[t](i[t]),c.map(e=>e[t]))))}else if("value"===this.categorizationMethod){const e={},n={};t.forEach(t=>{const i=c.map(e=>e[t]),a=u(i),o=l(i),r=[a,a+.25*(o-a),a+.5*(o-a),a+.75*(o-a),o];n[t]=r.map(t=>t.toFixed(2)),e[t]=function t(){var e,n=[.5],i=[0,1],a=1;function o(t){return t<=t?i[s(n,t,0,a)]:e}return o.domain=function(t){return arguments.length?(n=Array.from(t),a=Math.min(n.length,i.length-1),o):n.slice()},o.range=function(t){return arguments.length?(i=Array.from(t),a=Math.min(n.length,i.length-1),o):i.slice()},o.invertExtent=function(t){var e=i.indexOf(t);return[n[e-1],n[e]]},o.unknown=function(t){return arguments.length?(e=t,o):e},o.copy=function(){return t().domain(n).range(i).unknown(e)},y.apply(o,arguments)}().domain(r).range(r)}),console.log(c.map(n=>e[t[0]](n[t[0]]))),c.forEach(n=>t.forEach(t=>n["_"+t]=e[t](n[t]))),c.forEach(i=>t.forEach(t=>i["_"+t]=`${n[t][n[t].indexOf(e[t](i[t]).toFixed(2))-1]} ~ ${e[t](i[t]).toFixed(2)}`))}n||(d="select min(Latitude) as minLatitude, max(Latitude) as maxLatitude, count(distinct Latitude) as latitudeCount, min(Longitude) as minLongitude, max(Longitude) as maxLongitude, count(distinct Longitude) as longitudeCount from weather",p=null===(r=this.DB.exec(d))||void 0===r?void 0:r[0],this.datasetInfo=p.values.map(t=>{const e={};for(let n=0;n<t.length;n++)e[p.columns[n]]=+t[n];return e})[0]),await f.dismiss()}return c}obtainDateString(t){switch(t.substring(5)){case"01":return"Jan";case"02":return"Feb";case"03":return"Mar";case"04":return"Apr";case"05":return"May";case"06":return"Jun";case"07":return"Jul";case"08":return"Aug";case"09":return"Sep";case"10":return"Oct";case"11":return"Nov";case"12":return"Dec"}}};g.style=".sc-app-weather-vis-h{display:block}#file-input.sc-app-weather-vis{display:none}s-set-vis.sc-app-weather-vis{height:600px;width:calc(100% - 650px);display:inline-flex}iframe.sc-app-weather-vis{display:inline-block}";export{g as app_weather_vis}