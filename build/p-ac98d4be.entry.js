import{r as i,h as t,H as s}from"./p-ddbb1df8.js";import"./p-bec3b19e.js";import"./p-58d13c5e.js";import"./p-f3a0c163.js";import{l as e}from"./p-d5d1c985.js";import{s as n}from"./p-38942298.js";import{q as o,m as a,a as l,t as r}from"./p-84cb821d.js";const h=class{constructor(t){i(this,t),this.categoricalVariableOptions=["room_id","host_id","room_type","borough","neighborhood","bedrooms","_reviews","_overall_satisfaction","_accommodates","_price"],this.numericalVariableOptions=["reviews","overall_satisfaction","accommodates","bedrooms","price"],this.colorScheme=["#ff1744","#00e676","#2979ff","#ffea00","#00e5ff","#d500f9","#ff812d","#10fab7"],this.textureDefinitions=['this.textures.lines().orientation("4/8").size(1000)',"this.textures.circles().radius(2)",'this.textures.lines().orientation("2/8").size(10)','this.textures.lines().orientation("2/8").size(10).heavier()','this.textures.lines().orientation("8/8").size(10)','this.textures.lines().orientation("8/8").size(10).heavier()','this.textures.lines().orientation("6/8").size(10)','this.textures.lines().orientation("6/8").size(10).heavier()'],this.selectedParallelSetsVariables=[],this.selectedStatisticsColumnsVariables=[],this.categorizationMethod="value",this.categorizedValueMap=new Map,this.dateOptions=[]}async connectedCallback(){this.SQL=await n({locateFile:i=>"./assets/sql.js/"+i})}render(){var i;return t(s,null,t("ion-header",null,t("ion-toolbar",{color:"primary"},t("ion-title",null,"Weather Vis"," - "+((null===(i=this.file)||void 0===i?void 0:i.name)||"No File Opened")),t("ion-buttons",{slot:"start"},t("ion-back-button",{defaultHref:"/"})),t("ion-buttons",{slot:"end"},t("ion-button",{title:"Open",onClick:()=>this.fileInputElement.click()},t("ion-icon",{slot:"icon-only",name:"open"}))))),t("ion-content",{class:"ion-padding"},t("ion-item",{disabled:!this.file},t("ion-label",null,"Date"),t("ion-select",{onIonChange:async({detail:i})=>{this.selectedDate=i.value,this.updateData()}},this.dateOptions.map(i=>t("ion-select-option",null,i)))),t("ion-item",{disabled:!this.file},t("ion-label",null,"Categorization Method"),t("ion-select",{value:this.categorizationMethod,onIonChange:async({detail:i})=>{this.categorizationMethod=i.value,this.updateData()}},t("ion-select-option",null,"quantile"),t("ion-select-option",null,"value"))),t("ion-item",{disabled:!this.file},t("ion-label",null,"Parallel Sets Variables"),t("ion-select",{multiple:!0,onIonChange:async({detail:i})=>{this.selectedParallelSetsVariables=i.value,this.updateData()}},this.categoricalVariableOptions.map(i=>t("ion-select-option",null,i)))),t("ion-item",{disabled:!this.file},t("ion-label",null,"Statisitcs Columns Variables"),t("ion-select",{multiple:!0,onIonChange:async({detail:i})=>{this.selectedStatisticsColumnsVariables=i.value,this.updateData()}},this.numericalVariableOptions.map(i=>t("ion-select-option",null,i)))),t("s-set-vis",{ref:i=>this.setVisElement=i,"parallel-sets-ribbon-tension":.5,parallelSetsDimensions:[""],parallelSetsTexutureDefinitions:this.textureDefinitions,parallelSetsColorScheme:this.colorScheme,parallelSetsMaxSegmentLimit:7}),t("iframe",{width:"500",height:"500",style:{border:"0"},ref:async i=>{this.mapIframeElement=i;const t=await(await fetch("./assets/map.html")).text();i.contentDocument.querySelector("div#map")||(i.contentDocument.open(),i.contentDocument.write(t),i.contentDocument.close(),window.addEventListener("message",({data:t})=>{switch(t.type){case"hello":i.contentWindow.postMessage({type:"view center point",info:{location:[51.045868,-114.061627],zoom:10}},"*");break;case"select rect":this.updateData(t.info)}}))}}),t("ion-button",{onClick:()=>this.mapIframeElement.contentWindow.postMessage({type:"reset range selection"},"*")},"Remove Range Selection")),t("input",{id:"file-input",type:"file",ref:i=>this.fileInputElement=i,onInput:async({target:i})=>{var t,s;this.file=null===(t=i.files)||void 0===t?void 0:t[0];const n=await e.create({message:`Opening ${this.file.name}...`});await n.present();const o=await this.file.arrayBuffer();this.DB=new this.SQL.Database(new Uint8Array(o));const a=null===(s=this.DB.exec("select distinct substr(last_modified, 0, 11) from arbnb"))||void 0===s?void 0:s[0];this.dateOptions=a.values.map(i=>i[0].toString()),await n.dismiss()}}))}async updateData(i){if(this.selectedDate&&this.selectedParallelSetsVariables.length>0&&this.selectedStatisticsColumnsVariables.length>0){const t=await this.queryData(i);t&&(this.mapIframeElement.contentWindow.postMessage({type:"add pins",info:t.sort((i,t)=>t.overall_satisfaction-i.overall_satisfaction).slice(0,100).map(i=>[i.latitude,i.longitude])},"*"),this.setVisElement.data=t,this.setVisElement.parallelSetsDimensions=this.selectedParallelSetsVariables,this.setVisElement.statisticsPlotGroupDefinitions=this.selectedStatisticsColumnsVariables.map(i=>({dimensionName:i,visType:"box"})))}}async queryData(i){var t;let s=[],e=`select ${this.selectedParallelSetsVariables.filter(i=>"_"!==i[0]).concat(this.selectedStatisticsColumnsVariables).filter((i,t,s)=>s.indexOf(i)===t).join(", ")} from arbnb where substr(last_modified, 0, 11) = '${this.selectedDate}'`;i&&(e+=`and latitude >= ${i.minLat} and latitude <= ${i.maxLat} and longitude >= ${i.minLon} and longitude <= ${i.maxLon}`);const n=null===(t=this.DB.exec(e))||void 0===t?void 0:t[0];if(s=null==n?void 0:n.values.map(i=>{const t={};for(let s=0;s<i.length;s++)t[n.columns[s]]=this.numericalVariableOptions.find(i=>i===n.columns[s])?isNaN(+i[s])?0:+i[s]:i[s];return t}),s){this.categorizedValueMap=new Map;const i=this.selectedParallelSetsVariables.filter(i=>"_"===i[0]).map(i=>i.substring(1));if("quantile"===this.categorizationMethod){const t={};i.forEach(i=>t[i]=o().domain(s.map(t=>t[i]).sort()).range([.25,.5,.75,1])),i.forEach(i=>{const e=t[i].quantiles(),n=s.map(t=>t[i]),o=a(n),r=l(n);this.categorizedValueMap.set(i,[`${o.toFixed(2)} ~ ${(+e[0]).toFixed(2)}`,`${(+e[0]).toFixed(2)} ~ ${(+e[1]).toFixed(2)}`,`${(+e[1]).toFixed(2)} ~ ${(+e[2]).toFixed(2)}`,`${(+e[2]).toFixed(2)} ~ ${r.toFixed(2)}`])});const e=(i,t)=>{switch(t){case.25:return this.categorizedValueMap.get(i)[0];case.5:return this.categorizedValueMap.get(i)[1];case.75:return this.categorizedValueMap.get(i)[2];case 1:return this.categorizedValueMap.get(i)[3]}};s.forEach(s=>i.forEach(i=>s["_"+i]=e(i,t[i](s[i])))),i.forEach(i=>{this.categorizedValueMap.set(i,this.categorizedValueMap.get(i).filter(t=>s.filter(s=>s["_"+i]===t).length>0))})}else if("value"===this.categorizationMethod){const t={},e={};i.forEach(i=>{const n=s.map(t=>t[i]),o=a(n),h=l(n),c=[o,o+.25*(h-o),o+.5*(h-o),o+.75*(h-o),h];e[i]=c.map(i=>i.toFixed(2)),t[i]=r().domain(c).range([0,1,2,3]),this.categorizedValueMap.set(i,[`${c[0].toFixed(2)} ~ ${c[1].toFixed(2)}`,`${c[1].toFixed(2)} ~ ${c[2].toFixed(2)}`,`${c[2].toFixed(2)} ~ ${c[3].toFixed(2)}`,`${c[3].toFixed(2)} ~ ${c[4].toFixed(2)}`])}),s.forEach(s=>i.forEach(i=>s["_"+i]=this.categorizedValueMap.get(i)[t[i](s[i])])),i.forEach(i=>{this.categorizedValueMap.set(i,this.categorizedValueMap.get(i).filter(t=>s.filter(s=>s["_"+i]===t).length>0))})}}return s}};h.style=".sc-app-airbnb-vis-h{display:block}#file-input.sc-app-airbnb-vis{display:none}s-set-vis.sc-app-airbnb-vis{height:600px;widows:100%}";export{h as app_airbnb_vis}